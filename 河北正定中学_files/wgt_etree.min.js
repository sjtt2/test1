$define(["wgt_util","wgt_readyload"],function(L,e,N){return L.fn.etree=function(e){var r=this,x={},c=e.handler,d=e.conf,b=d.item,i=[],C=d.elements,t=d.treeData,f=d.commonConfig,k=f.isNeedBox;this.init=function(){if(!d.async||(t=B())&&0!=t.length){if(!(t.length<1)){0==f.isShowSubNode&&(f.deep=1),d.proxy&&(b=L._UTL.ask(d.proxy)),o();var e=v(t,1);p(e),u(r),c.onReady(r,C),N.setCompPostion(r.closest("div[id^=c_]"))}}else n()};var n=function(){L(r).html('<div class="e_AbnormalPrompt e_PromptNoneData-001 p_*"><div class="promptbox"><div class="prompt_title"><i class="iconfont first"></i><div class="font"><i class="iconfont"></i>没有数据记录</div></div><div class="prompt_content hide">请先在网站后台添加数据记录。</div></div></div>')},o=function(){for(var e in b)i.push(e)},u=function(e){s(e),a(e)};L.onTreeBoxClick=function(e,t,n,i,o){var s="";f&&f.boxSelected&&(s=f.boxSelected.zstyle),e.find("."+c_box).removeClass(s),t.addClass(s)},L.toggleOther=function(e,t){e.hasClass("js_clicked")||e.addClass(c_open),L.toggleButton(e,t)},L.toggleButton=function(e,t,n){var i=C[d.item[S(parseInt(t.attr("data-level"))+1)][0].key],o=C[d.item[S(parseInt(t.attr("data-level"))+1)][0].depandStyleKey];e.hasClass(c_open)||!0===n?(t.siblings(".e_box").addClass(t_hide),e.removeClass(c_open),e.removeClass(i.zstyle).addClass(o.zstyle),e.removeClass(i.style).addClass(o.style)):(t.siblings(".e_box").removeClass(t_hide),e.addClass(c_open),e.removeClass(o.zstyle).addClass(i.zstyle),e.removeClass(o.style).addClass(i.style),d.commonConfig.isExclusive&&t.parent(".e_box").siblings(".e_box").find(".js_box.active").each(function(e,t){L.toggleButton(L(this).find(">.e_icon"),L(this),!0)})),e.addClass("js_clicked")},L.treeButtonClick=function(e,t,n,i){var o=e.closest("."+c_box);if(!o.hasClass(c_last)){if("button"!=n.type){if(null==(n=L.findButtonItem(o,i)))return void L.toggleOther(e,o);if(!n.show)return e.hasClass("js_clicked")||e.addClass(c_open),void L.toggleOther(e,o);e=o.find(".e_icon")}var s=n.key,a=n.depandStyleKey;L.toggleButton(e,o,t,s,a)}},L.findButtonItem=function(e,t){var n=e.data("level"),i=S(n);return L.getTreeButtonConfig(i,t)},L.getTreeButtonConfig=function(e,t){for(var n=t[e],i=0;i<n.length;i++)if("button"==n[i].type)return n[i]},L.treeAfterReady=function(e,t){L.controlShowLine(e.find("."+c_showLine)),e.find(".e_icon").not("."+c_open).closest("."+c_box).closest(".e_box").siblings(".e_box").addClass(t_hide);var n=e.find("."+c_last).find(".e_icon");L._UTL.removeRegClass(n,/e_icon-*00(\S)*/).addClass(t.dot.style),L._UTL.removeRegClass(n,/p_[a-zA-Z]*\s{1}/).addClass(t.dot.zstyle),L("."+c_hide).addClass(t_hide),L("."+c_box).find("img").parent().putPhotoDiv();L(r).getScope();var i=f.margin;i&&i.show&&e.find(".js_box").css({"margin-left":i.left+"px","margin-right":i.right+"px","margin-bottom":i.bottom+"px","margin-top":i.top+"px"})};var s=function(l){l.find("."+c_box).on("click",function(e){var t=L(this);if(!t.siblings().find("."+c_box).length&&!t.hasClass(c_last)){for(var n=t.data("item"),i={},o=d.async.autoParam,s=0;s<d.async.autoParam.length;s++)i[o[s]]=n[o[s]];i.id||(i.id=o[s]);var a=L(v(B(i),n.deep+1));t.parent().append(a),a.find("img").each(function(e,t){var n=L(this).attr("errorImg");L(this).onErrorImg(n)}),L.treeAfterReady(a,C),u(t.siblings()),c.onClick&&c.onClick(r,t,n,C,f),L._UTL.stopEvent(e)}l.find("."+c_box).removeClass(c_active),t.addClass(c_active),N.setCompPostion(t.closest("div[id^=c_]"))})},a=function(e){for(var t in x){var n=e.find("."+t),i=x[t],o=i.action;for(var s in n.data("itemKey",t),o)l(n,s,i,e)}x={}},l=function(e,t,i,o){e.on(t,function(e){var t=L(this),n=i;n.action[e.type](o,t,n,t.closest("."+c_box).data("item"),C,b)})},v=function(e,t){for(var n="",i=0;i<e.length;i++){if(h("tree",t))return n;var o=e[i];o.deep=t,n+=y("widBox",o,!1,t),n+=y("01",o,!0,t),n+=m(o,t),n+=_(),n+=1==t?g(1):g(1,t-1),o.children&&(t+=1,n+=v(o.children,t),t-=1),n+=_()}return n},h=function(e,t){var n=!1;return null!=f&&null!=f.deep&&("tree"==e?t>f.deep&&(n=!0):"box"==e&&t==f.deep&&(n=!0)),n},g=function(e,t){var n=C.line;return t&&(n=C.line1),L._UTL.createElement("line",n)},y=function(e,t,n,i){var o=T(i),s=L._UTL.createElement("box",o);if(n){o.out&&(o=o.out);var a="";if(1<i&&(a="style='padding-left:"+22*(i-1)+"px'"),o.css=a,o.cstyle=c_box,(t.isParent||t.children&&0!=t.children.length)&&!h("box",i)||(o.cstyle=c_box+" "+c_last),f&&f.boxSelected)t[f.boxSelected.dataBind]&&(o.cstyle=o.cstyle+" "+f.boxSelected.zstyle);var l=L._UTL.createElement("$box",o,t,i).get(0).outerHTML;s=l.substring(0,l.length-6)}return s},T=function(e){var t=C.box;if(0==e||null==e)return t;if(f&&null!=f.isDefindSubNode&&!f.isDefindSubNode)return C.box[i[0]];for(var n=e-1;t=null==C.box[i[n]];){if(0==n)return C.box;n-=1}return C.box[i[n]]},_=function(){return L._UTL.createBoxEnd()},p=function(e){r.html(e),r.find(".e_line").last().remove(),r.find("img").each(function(e,t){var n=L(this).attr("errorImg");L(this).onErrorImg(n)})},S=function(e){if(0==(e-=1))return i[0];if(f&&null!=f.isDefindSubNode&&!f.isDefindSubNode)return i[0];for(;null==i[e];)e-=1;return i[e]},m=function(e,t){for(var n,i,o="",s=C,a=S(t),l=b[a].length,r=0;r<l;r++){var c=b[a][r],d=c.key,f=e[c.bindData];f||0==f||(f=c.v),c.depand&&(d=e[c.depand]?c.key:c.depandStyleKey);var u,v=L.extend(!0,{},s[d]),h="js_"+d,g="";c.action&&(-1!=h.indexOf("linkText")?(null!=s[d].link.cstyle&&(g=s[d].link.cstyle),-1==g.indexOf(h)&&(s[d].link.cstyle=g+" "+h)):(null!=s[d].cstyle&&(g=s[d].cstyle),-1==g.indexOf(h)&&(s[d].cstyle=g+" "+h)),x[h]=c),n=c.type,i=c,"linkText"==n&&null!=i.config&&i.config.isShowLineNum&&i.config.showlineNum&&(u=c.config.showlineNum);var y="";if(k&&"linkText"==c.type||null==k&&"linkText"==c.type){var _=T(t);_.inline&&(_=_.inline),y=L._UTL.createElement("box",_)}var p=s[d];if(undefined==c.show||c.show||("linkText"==c.type?w(p.link,t_hide):w(p,t_hide)),"title"==c.type){var m=c.move;m&&w(p,"js_"+m)}"thumb"==c.type&&(p.width=c.width,p.height=c.height,p.CuttingPic=c.CuttingPic,p.title=e.name,p.errorImg=c.errorImg),"button"==c.type&&(!0!==e.open&&"true"!==e.open||(p.cstyle+=" "+c_open)),y+=L._UTL.createElement(c.type,p,f,e,u),(k&&r+1==l||null==k&&r+1==l)&&(y+="</div>"),o+=y,s[d]=v}return o},w=function(e,t){null==e.cstyle?e.cstyle=t:-1==e.cstyle.indexOf(t)&&(e.cstyle=e.cstyle+" "+t)},B=function(e){var t,n={};return L.extend(n,d.async.otherParam,e),L.ajax({url:d.async.url,async:this.async||!1,type:d.async.type,dataType:"json",data:n,success:function(e){t=d.async.dataFilter?d.async.dataFilter(e):e}}),t};return this.triggerNode=function(e){this.async=!0;for(var t=e.length-1;0<=t;t--)if(0==t)this.find("#"+e[t]).addClass("active");else{var n=this.find("#"+e[t]).children(1);n.eq(0).hasClass("js_open")||n.trigger("click")}this.async=!1},this},L});